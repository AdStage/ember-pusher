class LicenseFilter < Rake::Pipeline::Filter
  def license
    @license ||= begin
      content = ""
      File.read("LICENSE").each_line do |line|
        content += "// #{line}".strip + "\n"
      end
      content
    end
  end

  def version
    @version ||= File.read("VERSION")
  end

  def generate_output(inputs, output)
    inputs.each do |input|
      output.write "#{license}"
      output.write "//\n// Ember Pusher v#{version}\n\n"
      output.write "#{File.read(input.fullpath)}"
    end
  end
end

class UglifyFilter < Rake::Pipeline::Filter
  def generate_output(inputs, output)
    inputs.each do |input|
      output.write Uglifier.compile(File.read(input.fullpath), mangle: true)
    end
  end
end

output "dist"

input "lib" do
  filter \
    Rake::Pipeline::OrderingConcatFilter,
    EmberPusher.package(:build_order),
    "ember-pusher#{EmberPusher.production? ? '.min' : ''}.js"
  filter UglifyFilter if EmberPusher.production?
  filter LicenseFilter
end
